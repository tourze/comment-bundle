# 评论系统开发工作文档

## 工作内容概述

### 需求背景
基于参考文档分析，开发一个通用的评论系统模块，支持多种认证方式、存储后端和交互功能。目标是创建一个模块化、可扩展的 Symfony Bundle，可以集成到各种 Web 应用中。

### 核心功能
1. **用户认证与权限管理**
   - 支持匿名评论（带权限限制）
   - 多级权限：游客、注册用户、管理员
   - JWT 令牌验证

2. **评论存储与管理**
   - 评论CRUD操作（创建、读取、更新、删除）
   - 评论嵌套回复（支持层级结构）
   - 评论审核机制（自动过滤+人工审核）
   - 评论搜索和分页

3. **评论展示与交互**
   - 点赞/踩功能
   - @提及用户功能
   - 评论排序（时间、热度）
   - 评论状态管理（置顶、隐藏、删除）

4. **反垃圾与安全**
   - 敏感词过滤
   - IP限制和封禁
   - 内容安全检查

### 技术范围
- **后端**: PHP 8.1+, Symfony 6.4+, Doctrine ORM
- **数据库**: 支持 MySQL/PostgreSQL
- **安全**: JWT认证, XSS防护, SQL注入防护
- **架构**: Symfony Bundle, DI容器, 事件系统

## 任务拆分与进度计划

| 任务阶段 | 具体任务项 | 优先级 | 预估耗时 | 进度状态 | 责任人 |
|----------|------------|--------|----------|----------|--------|
| 需求分析 | 1. 分析评论系统功能需求 | P0 | 1h | ⏳ | AI 工具 |
|          | 2. 设计数据库ER图和实体关系 | P0 | 2h | ⏳ | AI 工具 |
| 架构设计 | 1. 设计核心实体类(Comment, User等) | P0 | 3h | ⏳ | AI 工具 |
|          | 2. 设计服务层架构和接口定义 | P0 | 2h | ⏳ | AI 工具 |
|          | 3. 设计事件和监听器系统 | P1 | 2h | ⏳ | AI 工具 |
| 编码实现 | 1. 实现核心实体类 | P0 | 4h | ⏳ | AI 工具 |
|          | 2. 实现Repository层 | P0 | 3h | ⏳ | AI 工具 |
|          | 3. 实现Service层核心业务逻辑 | P0 | 5h | ⏳ | AI 工具 |
|          | 4. 实现事件监听器 | P1 | 3h | ⏳ | AI 工具 |
|          | 5. 实现命令行工具 | P2 | 2h | ⏳ | AI 工具 |
| 测试验收 | 1. 编写单元测试用例 | P0 | 4h | ⏳ | AI 工具 |
|          | 2. 编写集成测试 | P1 | 3h | ⏳ | AI 工具 |
|          | 3. 运行PHPStan静态分析 | P0 | 1h | ⏳ | AI 工具 |
|          | 4. 质量检查和代码规范验证 | P0 | 1h | ⏳ | AI 工具 |

## 验收条件清单

### 功能验收
- 所有PHP文件通过 PHPStan 校验：`./vendor/bin/phpstan analyse packages/comment-bundle/src -l 1`
- 评论CRUD操作正常运行
- 用户权限控制符合预期
- 评论嵌套回复功能正常
- 反垃圾机制有效拦截违规内容
- 所有测试用例100%通过

### 文档验收
- README.md 和 README.zh-CN.md 完整且一致
- API文档完整且与代码实现一致
- 代码注释清晰，复杂逻辑有中文说明

### 合规验收
- 代码遵循 PSR-1、PSR-4、PSR-12 规范
- 命名空间正确，符合 `Tourze\CommentBundle` 规范
- 代码通过安全扫描，无SQL注入、XSS等漏洞
- Bundle 配置正确，可正常集成到 Symfony 应用

## 特殊备注说明

### 技术约束
- 严格遵循 DRY、KISS、SOLID、YAGNI 原则
- 单个类/方法不超过200行，超过需重构
- 禁止在packages目录执行composer命令
- 测试在根目录执行：`./vendor/bin/phpunit packages/comment-bundle/tests`

### 安全要求
- 所有用户输入必须验证和过滤
- 使用参数化查询防止SQL注入
- 对输出内容进行XSS防护
- 敏感操作需要权限验证

### 性能考虑
- 数据库查询优化，避免N+1问题
- 合理使用缓存机制
- 分页查询避免大数据量加载
- 索引优化提升查询性能

## 执行流程说明

1. **文档驱动**: 本文档作为开发指导，所有开发任务需对照任务表执行
2. **进度跟踪**: 每完成一个任务及时更新进度状态
3. **质量保证**: 每个阶段完成后进行代码审查和测试
4. **验收确认**: 所有任务完成后按验收条件进行自测

开发完成时间预估: 2-3个工作日